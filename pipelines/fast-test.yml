trigger: none

pool:
  vmImage: ubuntu-latest

steps:

- template: templates/install-dependencies.yml
  parameters:
    platform: ubuntu-latest

- script: |
    export NNI_RELEASE=999.$(date -u +%Y%m%d%H%M%S)
    echo "##vso[task.setvariable variable=PATH]${PATH}:${HOME}/.local/bin"
    echo "##vso[task.setvariable variable=NNI_RELEASE]${NNI_RELEASE}"

    echo "Working directory: ${PWD}"
    echo "NNI version: ${NNI_RELEASE}"
    echo "Build docker image: $(build_docker_image)"

    python -m pip install --upgrade pip setuptools
  displayName: Prepare

- script: |
    set -e
    python setup.py build_ts
    python setup.py bdist_wheel -p manylinux1_x86_64
    python -m pip install dist/nni-${NNI_RELEASE}-py3-none-manylinux1_x86_64.whl[SMAC,BOHB]
  displayName: Build and install NNI

- task: Docker@2
  inputs:
    containerRegistry: msraieg-docker
    repository: nnidev/nni-nightly
    command: build
    Dockerfile: '**/Dockerfile'
    arguments: --build-arg NNI_RELEASE=$(NNI_RELEASE)
    tags: latest
  displayName: Build Docker Image

- task: Docker@2
  inputs:
    containerRegistry: msraieg-docker
    repository: nnidev/nni-nightly
    command: push
  displayName: Push Docker Image
